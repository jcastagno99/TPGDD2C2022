USE [GD2C2022]
GO

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--BEGIN TRANSACTION
GO

/*CREACION DE TABLAS*/

CREATE TABLE [NUEVE_Z].[BI_DIMENSION_CANAL_VENTA](
  [ID_DIM_CANAL_VENTA] [DECIMAL](19,0) NOT NULL,
  [TIPO_CANAL_VENTA] [NVARCHAR](2255) NULL,
  PRIMARY KEY ([ID_DIM_CANAL_VENTA])
)ON [PRIMARY]

CREATE TABLE [NUEVE_Z].[BI_DIMENSION_MEDIO_PAGO](
  [ID_DIM_MEDIO_PAGO] [DECIMAL](19,0) NOT NULL,
  [MEDIO_DE_PAGO_VENTA] [NVARCHAR](255) NULL,
  PRIMARY KEY ([ID_DIM_MEDIO_PAGO])
)ON [PRIMARY]

CREATE TABLE [NUEVE_Z].[BI_DIMENSION_TIPO_DESCUENTO](
  [ID_DIM_TIPO_DESCUENTO] [DECIMAL](19,0) NOT NULL,
  [ID_TIPO] [DECIMAL](19,0) NOT NULL,
  [DESCUENTO_VENTA_CONCEPTO] [NVARCHAR](255) NULL,
  PRIMARY KEY ([ID_DIM_TIPO_DESCUENTO],[ID_TIPO])
)ON [PRIMARY]

CREATE TABLE [NUEVE_Z].[BI_DIMENSION_TIEMPO](
  [ID_DIM_TIEMPO] [DECIMAL](19,0) IDENTITY(1,1) NOT NULL,
  [ANIO] [INT] NULL,
  [MES] [INT] NULL,
  PRIMARY KEY ([ID_DIM_TIEMPO])
)ON [PRIMARY]

CREATE TABLE [NUEVE_Z].[BI_DIMENSION_PRODUCTO](
  [ID_DIM_PRODUCTO] [NVARCHAR](50) NOT NULL,
  [PRODUCTO_NOMBRE] [NVARCHAR](50) NULL,
  PRIMARY KEY ([ID_DIM_PRODUCTO])
)ON [PRIMARY]

CREATE TABLE [NUEVE_Z].[BI_DIMENSION_RANGO_ETARIO](
  [ID_DIM_RANGO_ETARIO] [DECIMAL](19,0) IDENTITY(1,1) NOT NULL,
  [CLIENTE_CODIGO] [DECIMAL](19,0) NULL,
  [EDAD] [INT] NULL,
  [RANGO_ETARIO] [VARCHAR](10) NULL,
  PRIMARY KEY ([ID_DIM_RANGO_ETARIO])
)ON [PRIMARY]

CREATE TABLE [NUEVE_Z].[BI_DIMENSION_CATEGORIA_PRODUCTO](
  [ID_DIM_CATEGORIA_PRODUCTO] [DECIMAL](19,0) NOT NULL,
  [CATEGORIA] [NVARCHAR](50) NULL,
  PRIMARY KEY ([ID_DIM_CATEGORIA_PRODUCTO])
)ON [PRIMARY]

CREATE TABLE [NUEVE_Z].[BI_DIMENSION_PROVINCIA](
  [ID_DIM_PROVINCIA] [DECIMAL](19,0) NOT NULL,
  [PROVINCIA_NOMBRE] [NVARCHAR](50) NULL,
  PRIMARY KEY ([ID_DIM_PROVINCIA])
)ON [PRIMARY]

CREATE TABLE [NUEVE_Z].[BI_DIMENSION_TIPO_ENVIO](
  [ID_DIM_TIPO_ENVIO] [DECIMAL](19,0) NOT NULL,
  [MEDIO_DE_ENVIO] [NVARCHAR](255) NULL,
  PRIMARY KEY ([ID_DIM_TIPO_ENVIO])
)ON [PRIMARY]

CREATE TABLE [NUEVE_Z].[BI_HECHOS_INGRESOS](
  [ID_DIM_TIEMPO] [DECIMAL](19,0) NOT NULL,
  [ID_DIM_PRODUCTO] [NVARCHAR](50) NOT NULL,
  [ID_DIM_CANAL_VENTA] [DECIMAL](19,0) NOT NULL,
  [ID_DIM_MEDIO_PAGO] [DECIMAL](19,0) NOT NULL,
  [ID_DIM_TIPO_DESCUENTO] [DECIMAL](19,0) NOT NULL,
  [ID_TIPO] [DECIMAL](19,0) NOT NULL,
  [GANANCIAS_CANAL_VENTA] [DECIMAL](18,2) NULL,
  [TOTAL_INGRESOS_MP] [DECIMAL](18,2) NULL,
  [TOTAL_DESCUENTOS] [DECIMAL](18,2) NULL,
  PRIMARY KEY ([ID_DIM_TIEMPO], [ID_DIM_PRODUCTO], [ID_DIM_CANAL_VENTA], [ID_DIM_MEDIO_PAGO], [ID_DIM_TIPO_DESCUENTO]),
  CONSTRAINT [FK_HECHOS_INGRESOS.ID_DIM_TIEMPO]
    FOREIGN KEY ([ID_DIM_TIEMPO])
      REFERENCES [NUEVE_Z].[BI_DIMENSION_TIEMPO](ID_DIM_TIEMPO),
  CONSTRAINT [FK_HECHOS_INGRESOS.ID_DIM_PRODUCTO]
    FOREIGN KEY ([ID_DIM_PRODUCTO])
      REFERENCES [NUEVE_Z].[BI_DIMENSION_PRODUCTO](ID_DIM_PRODUCTO),
  CONSTRAINT [FK_HECHOS_INGRESOS.ID_DIM_CANAL_VENTA]
    FOREIGN KEY ([ID_DIM_CANAL_VENTA])
      REFERENCES [NUEVE_Z].[BI_DIMENSION_CANAL_VENTA](ID_DIM_CANAL_VENTA),
  CONSTRAINT [FK_HECHOS_INGRESOS.ID_DIM_MEDIO_PAGO]
    FOREIGN KEY ([ID_DIM_MEDIO_PAGO])
      REFERENCES [NUEVE_Z].[BI_DIMENSION_MEDIO_PAGO](ID_DIM_MEDIO_PAGO),
  CONSTRAINT [FK_HECHOS_INGRESOS.ID_DIM_TIPO_DESCUENTO]
    FOREIGN KEY ([ID_DIM_TIPO_DESCUENTO],[ID_TIPO])
      REFERENCES [NUEVE_Z].[BI_DIMENSION_TIPO_DESCUENTO](ID_DIM_TIPO_DESCUENTO,ID_TIPO)
)ON [PRIMARY]

CREATE TABLE [NUEVE_Z].[BI_HECHOS_PRODUCTOS](
  [ID_DIM_TIEMPO] [DECIMAL](19,0) NOT NULL,
  [ID_DIM_PRODUCTO] [NVARCHAR](50) NOT NULL,
  [ID_DIM_RANGO_ETARIO] [DECIMAL](19,0) NOT NULL,
  [ID_DIM_CATEGORIA_PRODUCTO] [DECIMAL](19,0) NOT NULL,
  [RENTABILIDAD_PRODUCTO] [DECIMAL](18,2) NULL,
  [VENTA_PRODUCTO] [DECIMAL](18,2) NULL,
  [REPOSICION_PRODUCTO] [DECIMAL](18,0) NULL,
  [PROMEDIO_PRECIO_PROVEEDOR] [DECIMAL](18,2) NULL,
  PRIMARY KEY ([ID_DIM_TIEMPO], [ID_DIM_PRODUCTO], [ID_DIM_RANGO_ETARIO], [ID_DIM_CATEGORIA_PRODUCTO]),
  CONSTRAINT [FK_HECHOS_PRODUCTOS.ID_DIM_TIEMPO]
    FOREIGN KEY ([ID_DIM_TIEMPO])
      REFERENCES [NUEVE_Z].[BI_DIMENSION_TIEMPO](ID_DIM_TIEMPO),
  CONSTRAINT [FK_HECHOS_PRODUCTOS.ID_DIM_PRODUCTO]
    FOREIGN KEY ([ID_DIM_PRODUCTO])
      REFERENCES [NUEVE_Z].[BI_DIMENSION_PRODUCTO](ID_DIM_PRODUCTO),
  CONSTRAINT [FK_HECHOS_PRODUCTOS.ID_DIM_RANGO_ETARIO]
    FOREIGN KEY ([ID_DIM_RANGO_ETARIO])
      REFERENCES [NUEVE_Z].[BI_DIMENSION_RANGO_ETARIO](ID_DIM_RANGO_ETARIO),
  CONSTRAINT [FK_HECHOS_PRODUCTOS.ID_DIM_CATEGORIA_PRODUCTO]
    FOREIGN KEY ([ID_DIM_CATEGORIA_PRODUCTO])
      REFERENCES [NUEVE_Z].[BI_DIMENSION_CATEGORIA_PRODUCTO](ID_DIM_CATEGORIA_PRODUCTO)
)ON [PRIMARY]

CREATE TABLE [NUEVE_Z].[BI_HECHOS_ENVIOS](
  [ID_DIM_TIEMPO] [DECIMAL](19,0) NOT NULL,
  [ID_DIM_PROVINCIA] [DECIMAL](19,0) NOT NULL,
  [ID_DIM_TIPO_ENVIO] [DECIMAL](19,0) NOT NULL,
  [ENVIOS_PROVINCIA] [DECIMAL](18,2) NULL,
  [VALOR_PROMEDIO_ENVIO] [DECIMAL](18,2) NULL,
  PRIMARY KEY ([ID_DIM_TIEMPO], [ID_DIM_PROVINCIA], [ID_DIM_TIPO_ENVIO]),
  CONSTRAINT [FK_HECHOS_ENVIOS.ID_DIM_TIEMPO]
    FOREIGN KEY ([ID_DIM_TIEMPO])
      REFERENCES [NUEVE_Z].[BI_DIMENSION_TIEMPO](ID_DIM_TIEMPO),
  CONSTRAINT [FK_HECHOS_ENVIOS.ID_DIM_PROVINCIA]
    FOREIGN KEY ([ID_DIM_PROVINCIA])
      REFERENCES [NUEVE_Z].[BI_DIMENSION_PROVINCIA](ID_DIM_PROVINCIA),
  CONSTRAINT [FK_HECHOS_ENVIOS.ID_DIM_TIPO_ENVIO]
    FOREIGN KEY ([ID_DIM_TIPO_ENVIO])
      REFERENCES [NUEVE_Z].[BI_DIMENSION_TIPO_ENVIO](ID_DIM_TIPO_ENVIO)
)ON [PRIMARY]

/*FIN CREACION DE TABLAS*/

/*MIGRACION DE DATOS*/

--------DIM_CANAL_VENTA----------
INSERT INTO [NUEVE_Z].[BI_DIMENSION_CANAL_VENTA] (ID_DIM_CANAL_VENTA, TIPO_CANAL_VENTA)
SELECT C.VENTA_CANAL_CODIGO, TC.TIPO_VENTA_CANAL 
FROM [NUEVE_Z].[CANAL_DE_VENTA] C
JOIN [NUEVE_Z].[TIPO_CANAL_DE_VENTA] TC 
ON (C.TIPO_VENTA_CANAL_CODIGO = TC.TIPO_VENTA_CANAL_CODIGO)

--------DIM_MEDIO_PAGO----------
INSERT INTO [NUEVE_Z].[BI_DIMENSION_MEDIO_PAGO] (ID_DIM_MEDIO_PAGO, MEDIO_DE_PAGO_VENTA)
SELECT MEDIO_DE_PAGO_VENTA_CODIGO, MEDIO_DE_PAGO_VENTA 
FROM [NUEVE_Z].[MEDIO_DE_PAGO_VENTA]

--------DIM_TIPO_DESCUENTO----------
INSERT INTO [NUEVE_Z].[BI_DIMENSION_TIPO_DESCUENTO] (ID_DIM_TIPO_DESCUENTO, ID_TIPO, DESCUENTO_VENTA_CONCEPTO)
SELECT DV.DESCUENTO_VENTA_CODIGO, 0, TDV.DESCUENTO_VENTA_CONCEPTO 
FROM [NUEVE_Z].[DESCUENTO_VENTA] DV
JOIN [NUEVE_Z].[TIPO_DESCUENTO_VENTA] TDV
ON (TDV.TIPO_DESCUENTO_VENTA_ID = DV.TIPO_DESCUENTO_VENTA_ID)


INSERT INTO [NUEVE_Z].[BI_DIMENSION_TIPO_DESCUENTO] (ID_DIM_TIPO_DESCUENTO, ID_TIPO, DESCUENTO_VENTA_CONCEPTO)
SELECT CPV.CUPON_POR_VENTA_ID, 1,'CUPON DE DESCUENTO'
FROM [NUEVE_Z].[CUPON_POR_VENTA] CPV

--------DIM_CATEGORIA_PRODUCTO----------
INSERT INTO [NUEVE_Z].[BI_DIMENSION_CATEGORIA_PRODUCTO] (ID_DIM_CATEGORIA_PRODUCTO, CATEGORIA)
SELECT CATEGORIA_CODIGO, CATEGORIA 
FROM [NUEVE_Z].[CATEGORIA]

--------DIM_PRODUCTO----------
INSERT INTO [NUEVE_Z].[BI_DIMENSION_PRODUCTO] (ID_DIM_PRODUCTO, PRODUCTO_NOMBRE)
SELECT PRODUCTO_CODIGO, PRODUCTO_NOMBRE 
FROM [NUEVE_Z].[PRODUCTO]

--------DIM_PROVINCIA----------
INSERT INTO [NUEVE_Z].[BI_DIMENSION_PROVINCIA] (ID_DIM_PROVINCIA, PROVINCIA_NOMBRE)
SELECT PROVINCIA_CODIGO, PROVINCIA_NOMBRE 
FROM [NUEVE_Z].[PROVINCIA]

--------DIM_TIPO_ENVIO----------
INSERT INTO [NUEVE_Z].[BI_DIMENSION_TIPO_ENVIO] (ID_DIM_TIPO_ENVIO, MEDIO_DE_ENVIO)
SELECT E.ENVIO_CODIGO, ME.MEDIO_DE_ENVIO
FROM [NUEVE_Z].[ENVIO] E
JOIN [NUEVE_Z].[MEDIO_DE_ENVIO] ME
ON (E.MEDIO_ENVIO_CODIGO = ME.MEDIO_ENVIO_CODIGO)

--------DIM_TIEMPO----------
INSERT INTO [NUEVE_Z].[BI_DIMENSION_TIEMPO] (ANIO, MES)
VALUES (2022,02)

INSERT INTO [NUEVE_Z].[BI_DIMENSION_TIEMPO] (ANIO, MES)
VALUES (2022,03)

INSERT INTO [NUEVE_Z].[BI_DIMENSION_TIEMPO] (ANIO, MES)
VALUES (2022,04)

INSERT INTO [NUEVE_Z].[BI_DIMENSION_TIEMPO] (ANIO, MES)
VALUES (2022,05)

INSERT INTO [NUEVE_Z].[BI_DIMENSION_TIEMPO] (ANIO, MES)
VALUES (2022,06)

INSERT INTO [NUEVE_Z].[BI_DIMENSION_TIEMPO] (ANIO, MES)
VALUES (2022,07)

INSERT INTO [NUEVE_Z].[BI_DIMENSION_TIEMPO] (ANIO, MES)
VALUES (2022,08)

INSERT INTO [NUEVE_Z].[BI_DIMENSION_TIEMPO] (ANIO, MES)
VALUES (2022,09)

INSERT INTO [NUEVE_Z].[BI_DIMENSION_TIEMPO] (ANIO, MES)
VALUES (2022,10)

INSERT INTO [NUEVE_Z].[BI_DIMENSION_TIEMPO] (ANIO, MES)
VALUES (2022,11)

INSERT INTO [NUEVE_Z].[BI_DIMENSION_TIEMPO] (ANIO, MES)
VALUES (2022,12)

INSERT INTO [NUEVE_Z].[BI_DIMENSION_TIEMPO] (ANIO, MES)
VALUES (2023,01)

--------DIM_RANGO_ETARIO----------
INSERT INTO [NUEVE_Z].[BI_DIMENSION_RANGO_ETARIO]
SELECT C.CLIENTE_CODIGO, (DATEDIFF(YEAR, C.CLIENTE_FECHA_NAC, CAST(GETDATE() AS DATE))),  CASE
																						WHEN (DATEDIFF(YEAR, C.CLIENTE_FECHA_NAC, CAST(GETDATE() AS DATE))) < 25 THEN '<25'
																						WHEN (DATEDIFF(YEAR, C.CLIENTE_FECHA_NAC, CAST(GETDATE() AS DATE)))  BETWEEN 25 AND 35 OR (DATEDIFF(YEAR, C.CLIENTE_FECHA_NAC, CAST(GETDATE() AS DATE))) = 25 THEN '<25'
																						WHEN (DATEDIFF(YEAR, CLIENTE_FECHA_NAC, CAST(GETDATE() AS DATE))) BETWEEN 35 AND 55 OR (DATEDIFF(YEAR, CLIENTE_FECHA_NAC, CAST(GETDATE() AS DATE))) = 35 THEN '25-35'
																						WHEN (DATEDIFF(YEAR, C.CLIENTE_FECHA_NAC, CAST(GETDATE() AS DATE))) > 55 THEN '>55'
																						END
FROM [NUEVE_Z].[CLIENTE] C

/*
INSERT INTO [NUEVE_Z].[BI_DIMENSION_RANGO_ETARIO]
SELECT (SELECT COUNT(DISTINCT CLIENTE_CODIGO) FROM [NUEVE_Z].[CLIENTE]
        WHERE (DATEDIFF(YEAR, CLIENTE_FECHA_NAC, CAST(GETDATE() AS DATE))) < 25),
        (SELECT COUNT(DISTINCT CLIENTE_CODIGO) FROM [NUEVE_Z].[CLIENTE]
        WHERE (DATEDIFF(YEAR, CLIENTE_FECHA_NAC, CAST(GETDATE() AS DATE))) BETWEEN 25 AND 35 OR (DATEDIFF(YEAR, CLIENTE_FECHA_NAC, CAST(GETDATE() AS DATE))) = 25),
        (SELECT COUNT(DISTINCT CLIENTE_CODIGO) FROM [NUEVE_Z].[CLIENTE]
        WHERE (DATEDIFF(YEAR, CLIENTE_FECHA_NAC, CAST(GETDATE() AS DATE))) BETWEEN 35 AND 55 OR (DATEDIFF(YEAR, CLIENTE_FECHA_NAC, CAST(GETDATE() AS DATE))) = 35),
        (SELECT COUNT(DISTINCT CLIENTE_CODIGO) FROM [NUEVE_Z].[CLIENTE]
        WHERE (DATEDIFF(YEAR, CLIENTE_FECHA_NAC, CAST(GETDATE() AS DATE))) > 55)*/


--------HECHOS_INGRESOS----------
INSERT INTO [NUEVE_Z].[BI_HECHOS_INGRESOS] (ID_DIM_TIEMPO, ID_DIM_PRODUCTO, ID_DIM_CANAL_VENTA, ID_DIM_MEDIO_PAGO, ID_DIM_TIPO_DESCUENTO, GANANCIAS_CANAL_VENTA, TOTAL_INGRESOS_MP, TOTAL_DESCUENTOS)
SELECT T.ID_DIM_TIEMPO, P.PRODUCTO_CODIGO, CV.VENTA_CANAL_CODIGO, MP.MEDIO_DE_PAGO_VENTA_CODIGO, DESV.VENTA_ID,
         SUM(DV.PRECIO_UNITARIO_VENTA * DV.VARIANTE_PRODUCTO_CANTIDAD) - SUM(DC.PRECIO_UNITARIO_COMPRA * DC.VARIANTE_PRODUCTO_CANTIDAD) - SUM(V.VENTA_MEDIO_PAGO_COSTO) GANANCIAS_CANAL_VENTA, --1
         SUM(DV.PRECIO_UNITARIO_VENTA * DV.VARIANTE_PRODUCTO_CANTIDAD) - SUM(COALESCE(V.VENTA_MEDIO_PAGO_COSTO,0)) - SUM(DESV.DESCUENTO_VENTA_IMPORTE) TOTAL_INGRESOS_MP, --2
         SUM(DESV.DESCUENTO_VENTA_IMPORTE) + SUM(CPV.VALOR_DESCUENTO) TOTAL_DESCUENTOS
FROM [NUEVE_Z].[PRODUCTO] P JOIN [NUEVE_Z].[VARIANTE_PRODUCTO] VP ON (VP.VARIANTE_PRODUCTO_CODIGO = P.PRODUCTO_VARIANTE)
JOIN [NUEVE_Z].[DETALLE_VENTA] DV ON (DV.VARIANTE_PRODUCTO_CODIGO = VP.VARIANTE_PRODUCTO_CODIGO)
JOIN [NUEVE_Z].[VENTA] V ON (V.VENTA_ID = DV.VENTA_ID)
JOIN [NUEVE_Z].[DESCUENTO_VENTA] DESV ON (V.VENTA_ID = DESV.VENTA_ID)
JOIN [NUEVE_Z].[CUPON_POR_VENTA] CPV ON (CPV.VENTA_ID = V.VENTA_ID)
JOIN [NUEVE_Z].[MEDIO_DE_PAGO_VENTA] MP ON (MP.MEDIO_DE_PAGO_VENTA_CODIGO = V.VENTA_MEDIO_PAGO_CODIGO)
JOIN [NUEVE_Z].[CANAL_DE_VENTA] CV ON (CV.VENTA_CANAL_CODIGO = V.VENTA_CANAL_CODIGO)
JOIN [NUEVE_Z].[DETALLE_COMPRA] DC ON (DC.VARIANTE_PRODUCTO_CODIGO = VP.VARIANTE_PRODUCTO_CODIGO)
JOIN [NUEVE_Z].[BI_DIMENSION_TIEMPO] T ON (YEAR(V.VENTA_FECHA) = T.ANIO AND MONTH(V.VENTA_FECHA) = T.MES)
GROUP BY T.ID_DIM_TIEMPO, P.PRODUCTO_CODIGO, CV.VENTA_CANAL_CODIGO, MP.MEDIO_DE_PAGO_VENTA_CODIGO, DESV.VENTA_ID
ORDER BY T.ID_DIM_TIEMPO

-- HAY QUE CHEQUEAR ESTO, PORQUE LOS NUMEROS SON MUY ALTOS, CAPAZ HAY QUE SEPARAR CADA CALCULO DE HECHO EN UNA TABLA TEMPORAL O CON UN UPDATE
-- 1) PARA LAS GANANCIAS MENSUALES EN LA VIEW HAY QUE AGRUPAR POR MES SEGURAMENTE (Y HACER SUM POR MES, EN ESTA FIGURA EL ID TIEMPO)
-- 2) IDEM PARA LOS INGRESOS POR MEDIO DE PAGO, LUEGO EN LA VIEW HAY QUE HACER SUM POR MES
-- 3) LO MISMO CON LOS DESCUENTOS, DESPUES LA VIEW PIDE POR TIPO DE DESCUENTO Y POR MES

--------HECHOS_PRODUCTOS----------

CREATE TABLE #PRECIOPROMPROV (
[PROVEEDOR_CODIGO] [DECIMAL](19,0),
[PRECIO_MAXIMO] [DECIMAL](18,2),
[PRECIO_MINIMO] [DECIMAL](18,2),
[COMPRA_FECHA_AÑO] [INT]
)

INSERT INTO #PRECIOPROMPROV
SELECT P.PROVEEDOR_CODIGO, (SELECT MAX(DC.PRECIO_UNITARIO_COMPRA) FROM [NUEVE_Z].[DETALLE_COMPRA] DC
							JOIN [NUEVE_Z].[COMPRA] C2 ON (DC.COMPRA_ID = C2.COMPRA_ID)
							WHERE C2.PROVEEDOR_CODIGO = P.PROVEEDOR_CODIGO AND YEAR(C2.COMPRA_FECHA) = YEAR(C.COMPRA_FECHA)), 
							(SELECT MIN(DC.PRECIO_UNITARIO_COMPRA) FROM [NUEVE_Z].[DETALLE_COMPRA] DC
							JOIN [NUEVE_Z].[COMPRA] C2 ON (DC.COMPRA_ID = C2.COMPRA_ID)
							WHERE C2.PROVEEDOR_CODIGO = P.PROVEEDOR_CODIGO AND YEAR(C2.COMPRA_FECHA) = YEAR(C.COMPRA_FECHA)),
YEAR(C.COMPRA_FECHA)
FROM [NUEVE_Z].[PROVEEDOR] P JOIN [NUEVE_Z].[COMPRA] C ON (C.PROVEEDOR_CODIGO = P.PROVEEDOR_CODIGO)
GROUP BY P.PROVEEDOR_CODIGO, YEAR(C.COMPRA_FECHA)
ORDER BY P.PROVEEDOR_CODIGO

INSERT INTO [NUEVE_Z].[BI_HECHOS_PRODUCTOS] (ID_DIM_TIEMPO, ID_DIM_PRODUCTO, ID_DIM_RANGO_ETARIO, ID_DIM_CATEGORIA_PRODUCTO, RENTABILIDAD_PRODUCTO, VENTA_PRODUCTO, REPOSICION_PRODUCTO, PROMEDIO_PRECIO_PROVEEDOR)
SELECT T.ID_DIM_TIEMPO, P.PRODUCTO_CODIGO, RE.ID_DIM_RANGO_ETARIO, C.CATEGORIA_CODIGO,
SUM(DV.PRECIO_UNITARIO_VENTA * DV.VARIANTE_PRODUCTO_CANTIDAD) - SUM(DC.PRECIO_UNITARIO_COMPRA * DC.VARIANTE_PRODUCTO_CANTIDAD) RENTABILIDAD_PRODUCTO,
SUM(DV.VARIANTE_PRODUCTO_CANTIDAD) VENTA_PRODUCTO,
SUM(DC.VARIANTE_PRODUCTO_CANTIDAD) REPOSICION_PRODUCTO,
PPP.PRECIO_MAXIMO - PPP.PRECIO_MINIMO / PPP.PRECIO_MINIMO
FROM [NUEVE_Z].[PRODUCTO] P JOIN [NUEVE_Z].[VARIANTE_PRODUCTO] VP ON (VP.VARIANTE_PRODUCTO_CODIGO = P.PRODUCTO_VARIANTE)
JOIN [NUEVE_Z].[CATEGORIA] C ON (C.CATEGORIA_CODIGO = P.PRODUCTO_CATEGORIA)
JOIN [NUEVE_Z].[DETALLE_VENTA] DV ON (DV.VARIANTE_PRODUCTO_CODIGO = VP.VARIANTE_PRODUCTO_CODIGO)
JOIN [NUEVE_Z].[DETALLE_COMPRA] DC ON (DC.VARIANTE_PRODUCTO_CODIGO = VP.VARIANTE_PRODUCTO_CODIGO)
JOIN [NUEVE_Z].[VENTA] V ON (V.VENTA_ID = DV.VENTA_ID)
JOIN [NUEVE_Z].[BI_DIMENSION_TIEMPO] T ON (YEAR(V.VENTA_FECHA) = T.ANIO AND MONTH(V.VENTA_FECHA) = T.MES)
JOIN [NUEVE_Z].[BI_DIMENSION_RANGO_ETARIO] RE ON (V.CLIENTE_CODIGO = RE.CLIENTE_CODIGO)
JOIN [NUEVE_Z].[COMPRA] COMP ON (COMP.COMPRA_ID = DC.COMPRA_ID)
JOIN #PRECIOPROMPROV PPP ON (PPP.PROVEEDOR_CODIGO = COMP.PROVEEDOR_CODIGO AND YEAR(COMP.COMPRA_FECHA) = PPP.COMPRA_FECHA_AÑO)
GROUP BY T.ID_DIM_TIEMPO, P.PRODUCTO_CODIGO, RE.ID_DIM_RANGO_ETARIO, C.CATEGORIA_CODIGO, PPP.PRECIO_MAXIMO, PPP.PRECIO_MINIMO
ORDER BY T.ID_DIM_TIEMPO

--FALTA CHEQUEAR REPETIDOS Y AGREGAR EL CODIGO DE PROVEEDOR COMO OTRA COLUMNA PARA MOSTRAR EN LA VIEW

-- 1) PARA LA VIEW DEL PRIMER DATO CALCULADO HAY QUE PASARLO A PORCENTAJE Y AGRUPAR POR AÑO, NO SE SI PASAR A PORCENTAJE AHORA
-- 2) ESTE DATO TIENE LA CANTIDAD DE PRODUCTOS VENDIDOS POR CADA PRODUCTO, LUEGO EN LA VIEW HAY QUE ORDENAR POR ESTE DATO (Y POR AÑO Y RANGO ETARIO) Y TOMAR EL TOP 5
-- 3) IDEM PERO TIENE LA CANTIDAD DE PRODUCTOS COMPRADOS, PARA REPOSICION HAY QUE SACAR EL TOP 3 POR MES